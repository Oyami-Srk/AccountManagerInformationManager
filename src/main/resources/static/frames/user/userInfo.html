<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>无标题文档</title>
    <link href="../../css/style.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="../../js/jquery.js"></script>
    <script type="text/javascript" src="../../js/utils.js"></script>
    <script type="text/javascript">
        function PostForSelectedUsers(url, data) {
            let ids = getSelectedIds();
            let t = ids.length;
            ids.forEach((id) => {
                data["id"] = id;
                $.ajax({
                    url,
                    data,
                    method: "POST"
                }).done((resp) => {
                    // TODO: check resp
                    t--;
                    if (t === 0) {
                        window.top.promptAlert("成功。");
                        fetch_page(page, count);
                    }
                })
            });
        }

        function confirmMsgDel() {
            if (confirm("删除用户信息,您确定要删除吗?")) {
                PostForSelectedUsers("/api/user/delete", {});
            }
        }

        function setUserStatus(enabled) {
            PostForSelectedUsers("/api/user/set_status", {
                enabled,
            });
        }

        function userOpen() {
            if (confirm("您确定要启用该用户吗?")) {
                setUserStatus(true);
            }
        }

        function userClose() {
            if (confirm("您确定要禁用该用户吗?")) {
                setUserStatus(false);
            }
        }

        function resetPass() {
            if (confirm("重置密码,您确定要恢复初始密码吗?")) {
                PostForSelectedUsers("/api/user/reset_password", {});
            }
        }

        function userUpdate() {
            if (getSelectedIds().length === 0) {
                window.top.promptAlert("请选择要修改的用户。");
            } else if (getSelectedIds().length > 1) {
                window.top.promptAlert("一次只能修改一个用户。");
            } else {
                window.location.replace("userInfoUpdate.html?id=" + getSelectedIds()[0].toString());
            }
        }
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $(".click").click(function () {
                $(".tip").fadeIn(200);
            });

            $(".tiptop a").click(function () {
                $(".tip").fadeOut(200);
            });

            $(".sure").click(function () {
                $(".tip").fadeOut(100);
            });

            $(".cancel").click(function () {
                $(".tip").fadeOut(100);
            });

        });
    </script>
    <script type="text/javascript">
        let total = null;
        let total_pages = null;
        let count = 5;
        let page = 1;
        // Get total count
        $(document).ready(() => {
            $.ajax({
                    url: "/api/user/count",
                    method: "GET"
                }
            ).done((resp) => {
                if (resp.status === "OK") {
                    total = resp.data;
                    total_pages = Math.floor(total / count) + ((total % count) === 0 ? 0 : 1);
                    $("#count").text(total)
                }
            });
            fetch_page(page, count);

            $("#allsel").click(() => {
                let checked = $("#allsel").prop('checked');
                for (let input of $("#datatable").find("input")) {
                    $(input).prop('checked', checked);
                }
            });

            $("#search_btn").click(() => {
                let userid = $("#search_id").val();
                let username = $("#search_name").val();
                if (userid.length === 0 && username.length === 0) {
                    page = 1;
                    $("#count").text(total);
                    fetch_page(page, count);
                } else {
                    if (userid.length === 0) {
                        userid = null;
                    } else if (isNaN(userid = parseInt(userid))) {
                        $("#alert_text", window.top.document).text("用户编号格式错误。");
                        window.top.syalert.syopen("alert");
                        $("#search_id").val('');
                        return;
                    }
                    if (username.length === 0) username = null;
                    fetch_user(userid, username);
                }
            });
        });

        // First pages
        function fetch_page(page, count) {
            $.ajax({
                    url: "/api/user/get",
                    method: "GET",
                    data: {
                        last: (page - 1) * count,
                        count: count
                    }
                }
            ).done((resp) => {
                $("#page").text(page);
                if (resp.status === "OK") {
                    $("#datatable").empty();
                    $("#allsel").prop('checked', false);
                    for (let user of resp.data) {
                        build_record(user.id, user.username, user.enabled, user.registration_time, user.last_login_time);
                    }
                }
            });
        }

        function fetch_user(id, username) {
            let data = {};
            if (id !== null) data["id"] = id;
            if (username != null) data["username"] = username;
            $.ajax({
                url: "/api/user/get",
                method: "GET",
                data
            }).done((resp) => {
                $("#datatable").empty();
                if (resp.status === "OK") {
                    $("#count").text(1);
                    $("#page").text(1);
                    let user = resp.data;
                    build_record(user.id, user.username, user.enabled, user.registration_time, user.last_login_time);
                }
            });
        }

        function build_record(id, username, status, resigter_time, last_login_time) {
            let tr = $("<tr/>", {
                id: id
            }).appendTo("#datatable");
            $("<input/>", {
                type: "checkbox"
            }).wrap("<td/>").parent().appendTo(tr);
            $("<td/>", {
                text: id
            }).appendTo(tr);
            $("<td/>", {
                text: username
            }).appendTo(tr);
            $("<td/>", {
                text: status ? "正常" : "停用"
            }).appendTo(tr);
            $("<td/>", {
                text: timestamp_to_date_string(resigter_time)
            }).appendTo(tr);
            $("<td/>", {
                text: timestamp_to_date_string(last_login_time)
            }).appendTo(tr);
        }

        function firstPage() {
            page = 1;
            fetch_page(page, count);
        }

        function lastPage() {
            if (total != null) {
                page = total_pages;
                fetch_page(page, count);
            }
        }

        function nextPage() {
            if (total != null) {
                if (page !== total_pages) {
                    page += 1;
                    fetch_page(page, count);
                }
            }
        }

        function previousPage() {
            if (page !== 1) {
                page--;
                fetch_page(page, count);
            }
        }

        function goPage() {
            let p = parseInt($("#textfield").val());
            if (p > 0 && p <= total_pages) {
                page = p;
                fetch_page(page, count);
            }
        }

        function getSelectedIds() {
            return Array.from($("#datatable")
                .find("input[type='checkbox']:checked")
                .map((_, b) =>
                    parseInt($(b).parent().parent().prop('id'))));
        }

    </script>
</head>

<body>
<div class="place">
    <span>位置：</span>
    <ul class="placeul">
        <li><a href="#">用户管理</a></li>
    </ul>
</div>
<div class="formbody">
    <ul class="searchform">
        <li><label>用户编号</label><input name="" type="text" id="search_id" class="scinput"/></li>
        <li><label>姓名</label><input name="" type="text" id="search_name" class="scinput"/></li>
        <li><label>&nbsp;</label><input name="" id="search_btn" type="submit" class="scbtn" value="查询"/></li>
    </ul>
</div>

<div class="rightinfo">
    <div class="tools">
        <ul class="toolbar1">
            <li><a href="userInfoAdd.html"><span><img src="../../images/t01.png"/></span>添加</a></li>
            <li><a href="javascript:userUpdate()"><span><img src="../../images/t02.png"/></span>修改</a></li>
            <li><a href="javascript:confirmMsgDel()"><span><img src="../../images/t03.png"/></span>删除</a></li>
            <li><a href="javascript:userOpen()"><span><img src="../../images/t08.png" height="24"
                                                           width="24"/></span>启用</a>
            </li>
            <li><a href="javascript:userClose()"><span><img src="../../images/t09.png" height="24" width="24"/></span>禁用</a>
            </li>
            <li><a href="javascript:resetPass()"><span><img src="../../images/t07.png" height="20" width="20"/></span>重置密码</a>
            </li>
        </ul>
    </div>
    <table class="tablelist">
        <thead>
        <tr class="tablehead">
            <td colspan="11">用户列表</td>
        </tr>
        </thead>
        <thead>
        <tr>
            <th><input id="allsel" type="checkbox" value=""/></th>
            <th>用户编号</th>
            <th>姓名</th>
            <th>状态</th>
            <th>注册时间</th>
            <th>最后登录时间</th>
        </tr>
        </thead>
        <tbody id="datatable">
        </tbody>
    </table>
    <div class="pagin">
        <table width="100%" border="0" cellspacing="0" cellpadding="0">
            <tr>
                <td class="STYLE4">
                    <div class="message">
                        共<i class="blue" id="count"></i>条记录，当前显示第<i class="blue" id="page"></i>页
                    </div>
                </td>
                <td>
                    <table border="0" align="right" cellpadding="0" cellspacing="0">
                        <tr>
                            <td width="45"><img src="../../images/first.gif" width="33" height="20" style="cursor:hand"
                                                onclick="firstPage()"/></td>
                            <td width="50"><img src="../../images/back.gif" width="43" height="20" style="cursor:hand"
                                                onclick="previousPage()"/></td>
                            <td width="50"><img src="../../images/next.gif" width="43" height="20" style="cursor:hand"
                                                onclick="nextPage()"/></td>
                            <td width="40"><img src="../../images/last.gif" width="33" height="20" style="cursor:hand"
                                                onclick="lastPage()"/></td>
                            <td width="100">
                                <div align="center"><span class="STYLE1">转到第
	                    <input id="textfield" type="text" size="4"
                               style="height:16px; width:35px; border:1px solid #999999;"/>
	                    页 </span></div>
                            </td>
                            <td width="40"><img src="../../images/go.gif" width="33" height="17" style="cursor:hand"
                                                onclick="goPage()"/></td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>
</div>

<script type="text/javascript">
    $('.tablelist tbody tr:odd').addClass('odd');
</script>

</body>

</html>
